<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Find Me – SPA Básica</title>
    <style>
        body { font-family: Arial; max-width:800px; margin:40px auto; padding:20px; }
        nav { margin-bottom:20px; }
        nav button { margin-right:10px; padding:8px 16px; }
        section { display:none; }
        section.active { display:block; }
        input, textarea, button { width:100%; margin-bottom:15px; padding:10px; border-radius:4px; border:1px solid #ccc; }
        table { width:100%; border-collapse:collapse; margin-top:20px; }
        th, td { padding:8px; border:1px solid #ddd; text-align:center; }
        img { max-width:80px; }
        #resultado { margin-top:10px; font-weight:bold; }
    </style>
</head>
<body>

<h1>Find Me (SPA básica)</h1>

<nav>
    <button id="btnNavForm">Registrar</button>
    <button id="btnNavList">Ver Lista</button>
</nav>

<!-- FORMULARIO -->
<section id="formSection" class="active">
    <h2>Registrar Persona Desaparecida</h2>
    <form id="formDesaparecido">
        <input type="text" id="nombre" placeholder="Nombre" required />
        <input type="text" id="apellido" placeholder="Apellido" required />
        <input type="number" id="edad" placeholder="Edad" min="0" required />
        <input type="text" id="dni" placeholder="DNI (7 a 10 dígitos)" pattern="[0-9]{7,10}" inputmode="numeric" maxlength="10" required/>
        <textarea id="descripcion" placeholder="Descripción" required></textarea>
        <input type="url" id="fotoUrl" placeholder="URL de la Foto (opcional)" />
        <button type="submit">Enviar</button>
    </form>
    <div id="resultado"></div>
</section>

<!-- LISTADO -->
<section id="listSection">
    <h2>Lista de Desaparecidos</h2>
    <button id="btnReload">↻ Recargar lista</button>
    <table>
        <thead>
        <tr>
            <th>Nombre</th><th>Apellido</th><th>DNI</th>
            <th>Descripción</th><th>Foto</th><th>Fecha</th>
        </tr>
        </thead>
        <tbody id="tablaDesaparecidosBody"></tbody>
    </table>
</section>

<script>
    const baseUrl = "/api/desaparecidos";

    // Navegación SPA
    document.getElementById("btnNavForm").onclick = ()=> {
      document.getElementById("formSection").classList.add("active");
      document.getElementById("listSection").classList.remove("active");
    };
    document.getElementById("btnNavList").onclick = ()=> {
      document.getElementById("listSection").classList.add("active");
      document.getElementById("formSection").classList.remove("active");
      loadList();
    };

    // Envío del formulario (POST)
    document.getElementById("formDesaparecido").addEventListener("submit", async (e) => {
      e.preventDefault();
      const v = id => document.getElementById(id).value.trim();

      const body = {
        nombre: v("nombre"),
        apellido: v("apellido"),
        edad: parseInt(v("edad"), 10),
        dni: v("dni"),
        descripcion: v("descripcion"),
        fotoUrl: v("fotoUrl") || "https://via.placeholder.com/150"
      };

      const out = document.getElementById("resultado");
      out.textContent = "";
      try {
        const resp = await fetch(baseUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        if (!resp.ok) {
          const errorText = await resp.text();
          throw new Error(errorText || `HTTP ${resp.status}`);
        }
        const creado = await resp.json();
        out.textContent = `✅ Persona registrada con ID: ${creado.id}`;
        out.style.color = "green";
        // opcional: limpiar el form
        e.target.reset();
      } catch (err) {
        out.textContent = "❌ " + err.message;
        out.style.color = "red";
      }
    });

    // Cargar lista (GET)
    document.getElementById("btnReload").onclick = loadList;
    async function loadList() {
      try {
        const resp = await fetch(baseUrl);
        if (!resp.ok) throw new Error("No se pudo cargar la lista");
        const data = await resp.json();
        renderTable(data);
      } catch (err) {
        console.error(err);
        alert("Error al cargar la lista");
      }
    }

    // Renderizar tabla (usa FrontDTO: foto y fechaFormateada)
    function renderTable(data) {
      const tbody = document.getElementById("tablaDesaparecidosBody");
      tbody.innerHTML = "";
      data.forEach(d => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.nombre}</td>
          <td>${d.apellido}</td>
          <td>${d.dni}</td>
          <td>${d.descripcion}</td>
          <td><img src="${d.foto}" alt="foto"/></td>
          <td>${d.fechaFormateada}</td>
        `;
        tbody.appendChild(tr);
      });
    }
</script>

</body>
</html>
